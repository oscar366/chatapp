<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Minimlist Chat App</title>
</head>
<body>
    <div class="container">
        <p class="msg">Messages:</p>
        <div id="messages" class="messages"></div>
        <form id="msgForm" class="msgForm">
            <input type="text" placeholder="Send message" class="input" id="inputBox" />
            <input type="submit" class="btn" value="Send">
        </form>
		<p class="username"></p>
    </div>

    <script type="text/javascript">
        // Prompt the user for a username
        const username = prompt("Enter your username:");
        
        // Check if the user entered a valid username, if not, stop execution
        if (!username) {
            alert("You must enter a username!");
            throw new Error("No username entered");
        }
        // Connect to the WebSocket server
        const ws = new WebSocket(`ws://${window.document.location.host}`);
        ws.binaryType = "blob";

        // Log socket opening and closing
        ws.addEventListener("open", event => {
            console.log("WebSocket connection opened");
        });

        ws.addEventListener("close", event => {
            console.log("WebSocket connection closed");
        });

        // Handle incoming messages
        ws.onmessage = function (message) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('msgCtn');
            
            // Try to parse the incoming message as JSON
            try {
                const data = JSON.parse(message.data);
                
                // If it's a 'history' type message, display the previous messages
                if (data.type === 'history') {
                    data.messages.forEach(msg => {
                        const historyMsgDiv = document.createElement('div');
                        historyMsgDiv.textContent = msg; // Use textContent to avoid HTML injection
                        document.getElementById('messages').appendChild(historyMsgDiv);
                    });
                }
                // Otherwise, treat it as a regular message
                else {
                    msgDiv.textContent = data; // Use textContent for regular messages
                    document.getElementById('messages').appendChild(msgDiv);
                }
            } catch (e) {
                // If it's not JSON (i.e., it's just plain text), treat it as a normal message
                console.log("Received non-JSON message:", message.data);
                msgDiv.textContent = message.data; // Use textContent for plain text
                document.getElementById('messages').appendChild(msgDiv);
            }
        }

        // Handle form submission to send a message
        const form = document.getElementById('msgForm');
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = document.getElementById('inputBox').value;
            if (message.trim()) {
                // Prepend the username to the message before sending
                const messageWithUsername = `${username}: ${message}`;
                ws.send(messageWithUsername);  // Send the message with the username to the WebSocket server
                document.getElementById('inputBox').value = ''; // Clear the input box
            }
        })
    </script>
</body>
</html>